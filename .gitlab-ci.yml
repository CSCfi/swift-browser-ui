stages:
  - verify
  - test
  - deploy

variables:
  BUILD_IMAGE: $ARTIFACTORY_SERVER/sds/sdd-common-ci

backend-lint:
  stage: verify
  tags:
    - docker-exec
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

  image: $BUILD_IMAGE
  before_script:
    - pip install pre-commit tox mypy .[dev]
  script:
    - pre-commit run --all-files -c .pre-commit-config.yaml --show-diff-on-failure --color never
    - tox -e docs
    - tox -e bandit

spellcheck:
  stage: verify
  tags:
    - docker-exec
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

  image: $BUILD_IMAGE
  before_script:
    - pip install pyspelling
  script:
    - pyspelling

frontend-lint:
  stage: verify
  tags:
    - docker-exec
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

  image: $BUILD_IMAGE
  before_script:
    - pnpm --prefix swift_browser_ui_frontend install --prod
  script:
    - pnpm --prefix swift_browser_ui_frontend lint

backend-test:
  stage: test
  tags:
    - docker-exec
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

  image: $BUILD_IMAGE
  before_script:
    - pnpm --prefix swift_browser_ui_frontend install --prod
    - pip install .[test]
  script:
    - pnpm --prefix swift_browser_ui_frontend docker-build
    - tox -e pytest
    - coverage run -m pytest tests/
    - coverage report --precision=1
  coverage: '/TOTAL.*\s+(\d+\%)/'

wasm-test:
  stage: test
  tags:
    - docker-exec
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  image: $BUILD_IMAGE
  before_script:
    - ruby --version
    - gem --version
    - gem install ceedling
  script:
    - cd swift_browser_ui_frontend/wasm
    - ceedling

deploy:
  rules:
    # until this is https://gitlab.com/groups/gitlab-org/-/epics/4529 is merged
    # ENVIRONMENT env var will not be sent downstream and it will default to devel branch
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual
    - if: '$CI_COMMIT_TAG !~ "/^$/"'
    - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
  variables:
    ENVIRONMENT: $CI_COMMIT_BRANCH
  stage: deploy
  trigger:
    project: sds-dev/sd-connect/swift-ui-csc-deployment
  allow_failure: true
