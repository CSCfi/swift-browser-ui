user		nginx nginx;
error_log	/tmp/nginx-error.log;
pid		/tmp/nginx.pid;

events {
	worker_connections	4096;
}

http {
	upstream app_server_front {
		# fail_timeout=0 means we always retry an upstream even if it failed
		# to return a good HTTP response
		server dev-ui:8081 max_fails=600 fail_timeout=1s;
	}
	upstream app_server_sharing {
		server dev-ui:9090 max_fails=600 fail_timeout=1s;
	}
	upstream app_server_request {
		server dev-ui:9091 max_fails=600 fail_timeout=1s;
	}
	upstream app_server_runner {
		server dev-ui:9092 max_fails=600 fail_timeout=1s;
	}
	upstream object_storage_server {
		server ${DOCKER_NETWORK_GATEWAY}:8080 max_fails=600 fail_timeout=1s;
	}
	upstream metadata_submitter_backend {
		server ${DOCKER_NETWORK_GATEWAY}:5430 max_fails=600 fail_timeout=1s;
	}

	upstream ceph_s3_host {
		server ${DEV_CEPH_ADDRESS}:8081;
	}

	client_max_body_size	0;

	server {
		listen			9443 ssl;
		ssl_certificate		/etc/ssl/sd-connect.devenv.crt;
		ssl_certificate_key	/etc/ssl/sd-connect.devenv.key;
		ssl_protocols		TLSv1.3;

		location / {
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header Host $http_host;
			proxy_redirect off;
			proxy_buffering off;
			proxy_pass http://app_server_sharing/;
		}
	}

	server {
		listen			10443 ssl;
		ssl_certificate		/etc/ssl/sd-connect.devenv.crt;
		ssl_certificate_key	/etc/ssl/sd-connect.devenv.key;
		ssl_protocols		TLSv1.3;

		location / {
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header Host $http_host;
			proxy_redirect off;
			proxy_buffering off;
			proxy_pass http://app_server_request/;
		}
	}

	server {
		listen			11443 ssl;
		ssl_certificate		/etc/ssl/sd-connect.devenv.crt;
		ssl_certificate_key	/etc/ssl/sd-connect.devenv.key;
		ssl_protocols		TLSv1.3;

		location / {
			proxy_http_version 1.1;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "Upgrade";
			proxy_set_header Host $http_host;
			proxy_redirect off;
			proxy_buffering off;
			proxy_pass http://app_server_runner/;
		}
	}

	server {
		listen				80	default_server;
		server_name			_;
		return				301	https://$host$request_uri;
	}

	server {
		listen				8443 ssl;
		listen				443 ssl;
		ssl_certificate		/etc/ssl/sd-connect.devenv.crt;
		ssl_certificate_key	/etc/ssl/sd-connect.devenv.key;
		ssl_protocols		TLSv1.3;
		server_name			sd-connect.devenv;

		location /ws {
			proxy_http_version 1.1;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "Upgrade";
			proxy_set_header Host $http_host;
			proxy_redirect off;
			proxy_buffering off;
			proxy_pass http://app_server_front/ws;
		}

		location / {
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "Upgrade";
			proxy_set_header Host $http_host;
			proxy_redirect off;
			proxy_buffering off;
			proxy_pass http://app_server_front/;
		}
	}

	server {
		listen				8079 ssl;
		ssl_certificate		/etc/ssl/sd-connect.devenv.crt;
		ssl_certificate_key /etc/ssl/sd-connect.devenv.key;
		ssl_protocols		TLSv1.3;

		location / {
			proxy_redirect off;
			proxy_pass https://object_storage_server/;
			add_header "Access-Control-Allow-Origin" "*";

			if ($request_method = "OPTIONS") {
				add_header "Access-Control-Allow-Origin" "*";
				add_header "Access-Control-Allow-Credentials" "true";
				add_header "Access-Control-Allow-Methods" "GET, POST, OPTIONS, PUT, DELETE";
				add_header "Access-Control-Allow-Headers" "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-Amz-Content-Sha256,Amz-Sdk-Invocation-Id,Amz-Sdk-Request,X-Amz-Date,X-Amz-User-Agent";
				add_header "Access-Control-Max-Age" 1728000;
				add_header "Content-Type" "text/plain; charset=utf-8";
				add_header "Content-Length" 0;
				return 204;
			}
		}
	}

	server {
		listen				8078 ssl;
		ssl_certificate		/etc/ssl/sd-connect.devenv.crt;
		ssl_certificate_key /etc/ssl/sd-connect.devenv.key;
		ssl_protocols		TLSv1.3;

		location / {
			proxy_redirect off;
			proxy_pass http://metadata_submitter_backend/;
			add_header "Access-Control-Allow-Origin" "*";

			if ($request_method = "OPTIONS") {
				add_header "Access-Control-Allow-Origin" "*";
				add_header "Access-Control-Allow-Credentials" "true";
				add_header "Access-Control-Allow-Methods" "GET, POST, OPTIONS, PUT, DELETE";
				add_header "Access-Control-Allow-Headers" "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-Amz-Content-Sha256,Amz-Sdk-Invocation-Id,Amz-Sdk-Request,X-Amz-Date,X-Amz-User-Agent";
				add_header "Access-Control-Max-Age" 1728000;
				add_header "Content-Type" "text/plain; charset=utf-8";
				add_header "Content-Length" 0;
				return 204;
			}
		}
	}

	server {
		listen				7443 ssl;
		listen				443	ssl;
		server_name 		rgw.devenv *.rgw.devenv;

		ssl_certificate		/etc/ssl/rgw.devenv.crt;
		ssl_certificate_key /etc/ssl/rgw.devenv.key;
		ssl_protocols		TLSv1.3;

		location / {
			proxy_redirect off;
			proxy_pass http://ceph_s3_host/;
			proxy_set_header	Host	$http_host;

			add_header "Access-Control-Allow-Origin" "*" always;
			add_header "Access-Control-Expose-Headers" "*" always;

			if ($request_method = "OPTIONS") {
			add_header "Access-Control-Allow-Origin" "*";
			add_header "Access-Control-Allow-Credentials" "true";
			add_header "Access-Control-Allow-Methods" "GET, POST, OPTIONS, PUT, DELETE";
			add_header "Access-Control-Allow-Headers" "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,Content-Md5,X-Amz-Content-Sha256,Amz-Sdk-Invocation-Id,Amz-Sdk-Request,X-Amz-Date,X-Amz-User-Agent,X-Amz-Acl";
			add_header "Access-Control-Max-Age" 1728000;
			add_header "Content-Type" "text/plain; charset=utf-8";
			add_header "Content-Length" 0;
			return 204;
			}
		}
	}
}
