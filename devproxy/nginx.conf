user		nginx nginx;
error_log	/tmp/nginx-error.log;
pid		/tmp/nginx.pid;

events {
	worker_connections	4096;
}

http {
	upstream app_server_front {
		# fail_timeout=0 means we always retry an upstream even if it failed
		# to return a good HTTP response
		server ${DOCKER_NETWORK_GATEWAY}:8081 fail_timeout=0;
	}
	upstream app_server_sharing {
		server ${DOCKER_NETWORK_GATEWAY}:9090 fail_timeout=0;
	}
	upstream app_server_request {
		server ${DOCKER_NETWORK_GATEWAY}:9091 fail_timeout=0;
	}
	upstream app_server_runner {
		server ${DOCKER_NETWORK_GATEWAY}:9092 fail_timeout=0;
	}
	upstream object_storage_server {
		server ${DOCKER_NETWORK_GATEWAY}:8080 fail_timeout=0;
	}
	upstream metadata_submitter_backend {
		server ${DOCKER_NETWORK_GATEWAY}:5430 fail_timeout=0;
	}

	client_max_body_size	0;

	server {
		listen			9443 ssl;
		ssl_certificate		/etc/ssl/swiftui-proxy.crt;
		ssl_certificate_key	/etc/ssl/swiftui-proxy.key;
		ssl_protocols		TLSv1.3;

		location / {
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header Host $http_host;
			proxy_redirect off;
			proxy_buffering off;
			proxy_pass http://app_server_sharing/;
		}
	}

	server {
		listen			10443 ssl;
		ssl_certificate		/etc/ssl/swiftui-proxy.crt;
		ssl_certificate_key	/etc/ssl/swiftui-proxy.key;
		ssl_protocols		TLSv1.3;

		location / {
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header Host $http_host;
			proxy_redirect off;
			proxy_buffering off;
			proxy_pass http://app_server_request/;
		}
	}

	server {
		listen			11443 ssl;
		ssl_certificate		/etc/ssl/swiftui-proxy.crt;
		ssl_certificate_key	/etc/ssl/swiftui-proxy.key;
		ssl_protocols		TLSv1.3;

		location / {
			proxy_http_version 1.1;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "Upgrade";
			proxy_set_header Host $http_host;
			proxy_redirect off;
			proxy_buffering off;
			proxy_pass http://app_server_runner/;
		}
	}

	server {
		listen			8443 ssl;
		ssl_certificate		/etc/ssl/swiftui-proxy.crt;
		ssl_certificate_key	/etc/ssl/swiftui-proxy.key;
		ssl_protocols		TLSv1.3;

		location /ws {
			proxy_http_version 1.1;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "Upgrade";
			proxy_set_header Host $http_host;
			proxy_redirect off;
			proxy_buffering off;
			proxy_pass http://app_server_front/ws;
		}

		location / {
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "Upgrade";
			proxy_set_header Host $http_host;
			proxy_redirect off;
			proxy_buffering off;
			proxy_pass http://app_server_front/;
		}
	}

	server {
		listen				8079 ssl;
		ssl_certificate		/etc/ssl/swiftui-proxy.crt;
		ssl_certificate_key /etc/ssl/swiftui-proxy.key;
		ssl_protocols		TLSv1.3;

		location / {
			proxy_redirect off;
			proxy_pass https://object_storage_server/;
			add_header "Access-Control-Allow-Origin" "*";

			if ($request_method = "OPTIONS") {
				add_header "Access-Control-Allow-Origin" "*";
				add_header "Access-Control-Allow-Credentials" "true";
				add_header "Access-Control-Allow-Methods" "GET, POST, OPTIONS, PUT, DELETE";
				add_header "Access-Control-Allow-Headers" "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-Amz-Content-Sha256,Amz-Sdk-Invocation-Id,Amz-Sdk-Request,X-Amz-Date,X-Amz-User-Agent";
				add_header "Access-Control-Max-Age" 1728000;
				add_header "Content-Type" "text/plain; charset=utf-8";
				add_header "Content-Length" 0;
				return 204;
			}
		}
	}

	server {
		listen				8078 ssl;
		ssl_certificate		/etc/ssl/swiftui-proxy.crt;
		ssl_certificate_key /etc/ssl/swiftui-proxy.key;
		ssl_protocols		TLSv1.3;

		location / {
			proxy_redirect off;
			proxy_pass http://metadata_submitter_backend/;
			add_header "Access-Control-Allow-Origin" "*";

			if ($request_method = "OPTIONS") {
				add_header "Access-Control-Allow-Origin" "*";
				add_header "Access-Control-Allow-Credentials" "true";
				add_header "Access-Control-Allow-Methods" "GET, POST, OPTIONS, PUT, DELETE";
				add_header "Access-Control-Allow-Headers" "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-Amz-Content-Sha256,Amz-Sdk-Invocation-Id,Amz-Sdk-Request,X-Amz-Date,X-Amz-User-Agent";
				add_header "Access-Control-Max-Age" 1728000;
				add_header "Content-Type" "text/plain; charset=utf-8";
				add_header "Content-Length" 0;
				return 204;
			}
		}
	}
}
